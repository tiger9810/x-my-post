# 本番環境デプロイ準備 - Statement of Work (SOW)

## 概要

このドキュメントは、X My Postsアプリケーションを本番環境にデプロイする前に実施すべき作業を定義します。

**重要**: 現在のコードには開発用のデバッグログが含まれており、APIキーやアクセストークンの一部が出力されています。これらは**セキュリティリスク**となるため、本番デプロイ前に必ず対処する必要があります。

---

## 1. セキュリティ対策（最優先）

### 1.1 デバッグログの削除・条件分岐化

**現状の問題**:
以下のファイルで機密情報を含むログが出力されています：

- `app/api/twitter/me/route.ts`
- `app/api/twitter/create/route.ts`
- `app/api/twitter/tweets/route.ts`

**出力されている機密情報**:
```typescript
console.log("Making request to Twitter API:", {
    accessTokenPrefix: session.accessToken?.substring(0, 10) + "..."
});
```

**対応方法**:

#### オプション1: 開発環境でのみログを出力（推奨）

```typescript
if (process.env.NODE_ENV === 'development') {
    console.log("Debug info:", { ... });
}
```

#### オプション2: 完全に削除

本番環境では不要なログをすべて削除

**作業項目**:
- [ ] すべてのAPIルートファイルでデバッグログを確認
- [ ] アクセストークンを含むログを削除または条件分岐化
- [ ] セッション情報を含むログを削除または条件分岐化
- [ ] エラーログは残す（ただし機密情報を含まないように）

**見積もり時間**: 1-2時間

---

### 1.2 NextAuth.jsのデバッグモードの無効化

**現状**:
```typescript
debug: process.env.NODE_ENV === "development"
```

**確認事項**:
- [ ] `lib/auth.ts`のdebugオプションが開発環境でのみ有効になっているか確認
- [ ] 本番ビルド時にデバッグログが出力されないことを確認

**見積もり時間**: 15分

---

### 1.3 環境変数の検証

**確認事項**:
- [ ] `.env.local`が`.gitignore`に含まれているか
- [ ] 本番環境用の環境変数が別途用意されているか
- [ ] APIキーやシークレットがコードに直接書かれていないか

**見積もり時間**: 30分

---

## 2. コードクリーンアップ

### 2.1 不要なconsole.logの削除

**対象ファイル**:
- `app/api/twitter/me/route.ts`
- `app/api/twitter/create/route.ts`
- `app/api/twitter/tweets/route.ts`
- `app/api/twitter/delete/[id]/route.ts`
- クライアント側コンポーネント

**削除対象**:
```typescript
// 削除または条件分岐化
console.log("Session in /api/twitter/me:", { ... });
console.log("Making request to Twitter API:", { ... });
console.log("Twitter API response:", { ... });
```

**保持すべきログ**:
```typescript
// エラーログは保持（ただし機密情報を含まないように）
console.error("Error in /api/twitter/create:", error.message);
console.error("Rate limit exceeded");
```

**作業項目**:
- [ ] すべてのAPIルートファイルを確認
- [ ] デバッグ用console.logを削除または条件分岐化
- [ ] エラーログを確認し、機密情報が含まれていないか検証
- [ ] クライアント側のconsole.logも確認

**見積もり時間**: 2-3時間

---

### 2.2 エラーメッセージの改善

**現状の問題**:
一部のエラーメッセージが開発者向けで、エンドユーザーには分かりにくい

**改善例**:

```typescript
// Before
throw new Error(error.detail || "Failed to create tweet");

// After
throw new Error("投稿に失敗しました。しばらくしてから再度お試しください。");
```

**作業項目**:
- [ ] すべてのエラーメッセージを確認
- [ ] ユーザーフレンドリーな日本語メッセージに変更
- [ ] 技術的な詳細はサーバーログに記録

**見積もり時間**: 1時間

---

## 3. 本番環境設定

### 3.1 Twitter Developer Portalの設定更新

**作業項目**:

1. **Callback URL / Redirect URLの追加**:
   ```
   https://your-production-domain.com/api/auth/callback/twitter
   ```
   
   **重要**: 既存のローカル開発用URL（`http://localhost:3000/...`）は残したまま、本番URLを追加

2. **Website URLの更新**:
   ```
   https://your-production-domain.com
   ```

3. **App permissionsの確認**:
   - 「Read and Write」になっているか確認

**見積もり時間**: 30分

---

### 3.2 本番環境用環境変数の設定

**Vercelの場合**:

1. Vercelダッシュボードで環境変数を設定：

```bash
# Twitter API Credentials
TWITTER_CLIENT_ID=your_client_id
TWITTER_CLIENT_SECRET=your_client_secret

# NextAuth.js Configuration
NEXTAUTH_URL=https://your-production-domain.com
NEXTAUTH_SECRET=your_production_secret_here
```

2. **重要**: 本番環境用の`NEXTAUTH_SECRET`は開発環境とは別の値を使用

**生成方法**:
```bash
openssl rand -base64 32
```

**作業項目**:
- [ ] 本番環境用の`NEXTAUTH_SECRET`を生成
- [ ] デプロイプラットフォームに環境変数を設定
- [ ] 環境変数が正しく設定されているか確認

**見積もり時間**: 30分

---

### 3.3 Next.js設定の確認

**`next.config.ts`の確認**:

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  // 本番環境用の設定を追加
  reactStrictMode: true,
  
  // 画像の最適化設定（必要に応じて）
  images: {
    domains: ['pbs.twimg.com'], // Twitterの画像ドメイン
  },
};

export default nextConfig;
```

**作業項目**:
- [ ] `reactStrictMode`が有効になっているか確認
- [ ] 必要に応じて画像ドメインを設定
- [ ] その他の本番環境用設定を追加

**見積もり時間**: 30分

---

## 4. ビルドとテスト

### 4.1 本番ビルドのテスト

**作業手順**:

```bash
# 本番ビルドを実行
npm run build

# ビルドが成功することを確認
# エラーがないか確認

# 本番モードでローカル起動
npm run start

# 動作確認
```

**確認項目**:
- [ ] ビルドエラーがないか
- [ ] TypeScriptの型エラーがないか
- [ ] 本番モードで正常に起動するか
- [ ] すべての機能が動作するか

**見積もり時間**: 1時間

---

### 4.2 機能テスト

**テスト項目**:

1. **認証フロー**:
   - [ ] サインインが成功するか
   - [ ] サインアウトが成功するか
   - [ ] セッションが正しく保持されるか

2. **ツイート機能**:
   - [ ] ツイートの投稿が成功するか
   - [ ] ツイートの削除が成功するか
   - [ ] ツイート一覧の取得が成功するか

3. **エラーハンドリング**:
   - [ ] ネットワークエラー時の挙動
   - [ ] レート制限時の挙動
   - [ ] 認証エラー時の挙動

**見積もり時間**: 2時間

---

## 5. デプロイ

### 5.1 Vercelへのデプロイ（推奨）

**手順**:

1. **GitHubリポジトリの準備**:
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin your-repo-url
   git push -u origin main
   ```

2. **Vercelでプロジェクトをインポート**:
   - [Vercel](https://vercel.com)にアクセス
   - 「New Project」をクリック
   - GitHubリポジトリを選択
   - 環境変数を設定
   - デプロイ

3. **デプロイ後の確認**:
   - デプロイが成功したか確認
   - 本番URLにアクセスして動作確認

**作業項目**:
- [ ] GitHubリポジトリを作成
- [ ] コードをプッシュ
- [ ] Vercelでプロジェクトをインポート
- [ ] 環境変数を設定
- [ ] デプロイを実行
- [ ] 動作確認

**見積もり時間**: 1-2時間

---

### 5.2 デプロイ後の動作確認

**確認項目**:

1. **基本機能**:
   - [ ] サインインが成功するか
   - [ ] ツイートの投稿が成功するか
   - [ ] ツイートの削除が成功するか

2. **パフォーマンス**:
   - [ ] ページの読み込み速度
   - [ ] APIレスポンス時間

3. **セキュリティ**:
   - [ ] HTTPSで接続されているか
   - [ ] デバッグログが出力されていないか
   - [ ] 機密情報が漏洩していないか

**見積もり時間**: 1時間

---

## 6. モニタリングとメンテナンス

### 6.1 エラーモニタリングの設定

**推奨ツール**:
- Vercel Analytics（無料）
- Sentry（エラートラッキング）

**作業項目**:
- [ ] Vercel Analyticsを有効化
- [ ] エラーログの確認方法を確立
- [ ] アラート設定（オプション）

**見積もり時間**: 1時間

---

### 6.2 ドキュメントの更新

**作成すべきドキュメント**:

1. **README.md**:
   - プロジェクトの概要
   - セットアップ手順
   - 環境変数の説明

2. **DEPLOYMENT.md**:
   - デプロイ手順
   - トラブルシューティング

**作業項目**:
- [ ] README.mdを作成
- [ ] DEPLOYMENT.mdを作成
- [ ] 環境変数のドキュメント化

**見積もり時間**: 2時間

---

## 7. 作業スケジュール

### フェーズ1: セキュリティ対策（必須）
- **期間**: 1日
- **作業時間**: 4-6時間
- **内容**: デバッグログの削除、環境変数の検証

### フェーズ2: コードクリーンアップ
- **期間**: 1日
- **作業時間**: 3-4時間
- **内容**: 不要なログの削除、エラーメッセージの改善

### フェーズ3: 本番環境設定
- **期間**: 半日
- **作業時間**: 2-3時間
- **内容**: Twitter Developer Portal設定、環境変数設定

### フェーズ4: ビルドとテスト
- **期間**: 半日
- **作業時間**: 3-4時間
- **内容**: 本番ビルド、機能テスト

### フェーズ5: デプロイ
- **期間**: 半日
- **作業時間**: 2-3時間
- **内容**: Vercelデプロイ、動作確認

### フェーズ6: ドキュメント作成
- **期間**: 半日
- **作業時間**: 2-3時間
- **内容**: README、デプロイガイド作成

**合計見積もり時間**: 16-23時間（2-3日）

---

## 8. チェックリスト

### デプロイ前の最終確認

- [ ] すべてのデバッグログが削除または条件分岐化されている
- [ ] 機密情報（APIキー、トークン）がログに出力されていない
- [ ] 本番ビルドが成功する
- [ ] すべての機能が正常に動作する
- [ ] 環境変数が正しく設定されている
- [ ] Twitter Developer Portalの設定が完了している
- [ ] エラーハンドリングが適切に実装されている
- [ ] ドキュメントが最新の状態である

### デプロイ後の確認

- [ ] 本番環境で認証が成功する
- [ ] ツイートの投稿・削除が成功する
- [ ] エラーが発生していない
- [ ] パフォーマンスが許容範囲内
- [ ] セキュリティ上の問題がない

---

## 9. リスクと対策

### リスク1: デバッグログからの情報漏洩

**リスクレベル**: 高

**対策**:
- すべてのデバッグログを削除または条件分岐化
- 本番環境でログを確認し、機密情報が出力されていないことを確認

### リスク2: 環境変数の設定ミス

**リスクレベル**: 中

**対策**:
- デプロイ前に環境変数を二重チェック
- デプロイ後に動作確認を徹底

### リスク3: Twitter API制限

**リスクレベル**: 中

**対策**:
- レート制限を考慮した実装（既に実装済み）
- キャッシュの活用
- ユーザーへの適切なエラーメッセージ表示

---

## 10. 次のステップ

デプロイ完了後、以下の改善を検討：

1. **パフォーマンス最適化**:
   - 画像の最適化
   - コード分割
   - キャッシュ戦略の改善

2. **機能追加**:
   - 画像付きツイート
   - スレッド機能
   - 下書き保存

3. **モニタリング強化**:
   - エラートラッキング
   - パフォーマンスモニタリング
   - ユーザー分析

---

## まとめ

このSOWに従って作業を進めることで、安全かつ確実に本番環境へのデプロイが可能です。

**最優先事項**: セキュリティ対策（フェーズ1）は必ず実施してください。デバッグログからの情報漏洩は重大なセキュリティリスクです。

ご質問や不明点があれば、お気軽にお問い合わせください。
